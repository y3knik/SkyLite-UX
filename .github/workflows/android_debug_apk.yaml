name: Build Debug APK (Continuous)

on:
  push:
    branches:
      - '**' # Build on all branches
    paths:
      - 'app/**'
      - 'server/**'
      - 'public/**'
      - 'capacitor.config.ts'
      - 'nuxt.config.ts'
      - 'package.json'
      - 'android/**'
      - '.github/workflows/android_debug_apk.yaml'
  workflow_dispatch: # Allow manual trigger

jobs:
  build-debug-apk:
    name: Build Debug APK
    runs-on: ubuntu-latest
    timeout-minutes: 30 # Prevent job from running forever

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Build Nuxt static site
        env:
          CAPACITOR_BUILD: 'true' # Disable server plugins to prevent hanging
        run: |
          # Use timeout to force-kill if npm doesn't exit cleanly
          timeout 8m npm run generate || {
            echo "Build timed out but likely completed - checking output..."
            if [ -d ".output/public" ] && [ -f ".output/public/index.html" ]; then
              echo "âœ“ Static site generated successfully"
              exit 0
            else
              echo "âœ— Build failed - no output found"
              exit 1
            fi
          }

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew

      - name: Build debug APK
        run: cd android && ./gradlew assembleDebug --no-daemon

      - name: Get short SHA
        id: slug
        run: echo "sha8=$(echo ${GITHUB_SHA} | cut -c1-8)" >> $GITHUB_OUTPUT

      - name: Rename APK with branch and commit
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/\//-/g')
          cp android/app/build/outputs/apk/debug/app-debug.apk \
             skylite-${SAFE_BRANCH}-${{ steps.slug.outputs.sha8 }}-debug.apk

      - name: Upload debug APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: skylite-${{ github.run_id }}-debug-apk
          path: skylite-*-debug.apk
          retention-days: 30

      - name: Generate build summary
        if: always()
        run: |
          echo "## ðŸ“± Android Debug APK Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ steps.slug.outputs.sha8 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f android/app/build/outputs/apk/debug/app-debug.apk ]; then
            SIZE=$(du -h android/app/build/outputs/apk/debug/app-debug.apk | cut -f1)
            echo "### âœ… Build Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **APK Size:** ${SIZE}" >> $GITHUB_STEP_SUMMARY
            echo "- **Filename:** \`skylite-${{ github.ref_name }}-${{ steps.slug.outputs.sha8 }}-debug.apk\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¦ Download" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to the **Actions** tab" >> $GITHUB_STEP_SUMMARY
            echo "2. Click on this workflow run" >> $GITHUB_STEP_SUMMARY
            echo "3. Scroll to **Artifacts** section at bottom" >> $GITHUB_STEP_SUMMARY
            echo "4. Download the APK" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“² Installation" >> $GITHUB_STEP_SUMMARY
            echo "1. Transfer APK to Android device" >> $GITHUB_STEP_SUMMARY
            echo "2. Enable **Unknown sources** in Settings" >> $GITHUB_STEP_SUMMARY
            echo "3. Tap APK file to install" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          fi
